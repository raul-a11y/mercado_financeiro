<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kanban Dinâmico - Mercado Financeiro</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      cursor: pointer;
    }
    /* Container e grid */
    #columns-container {
      display: grid;
      gap: 1rem;
      /* grid-template-columns vai ser setado via JS */
    }
    /* Coluna */
    .column {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      padding: 1rem;
      min-height: 250px;
    }
    /* Título editável */
    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .column-header input[type="text"] {
      font-weight: 600;
      font-size: 1.1rem;
      border: none;
      border-bottom: 2px solid transparent;
      outline: none;
      width: 100%;
      background: transparent;
      transition: border-color 0.3s;
    }
    .column-header input[type="text"]:focus {
      border-color: #3b82f6;
    }
    .remove-column-btn {
      background: transparent;
      border: none;
      color: #ef4444;
      font-weight: bold;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0 5px;
      user-select: none;
    }
    /* Lista tarefas */
    ul.task-list {
      flex-grow: 1;
      overflow-y: auto;
      min-height: 150px;
      padding-left: 0;
      margin: 0;
      list-style: none;
    }
    ul.task-list li {
      background: #e5e7eb;
      padding: 0.6rem 1rem;
      margin: 0.5rem 0;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    ul.task-list li.dragging {
      opacity: 0.6;
    }
    /* Botão adicionar etapa */
    #add-column-btn {
      background-color: #22c55e;
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    /* Modal */
    #modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #modal {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      width: 320px;
      max-width: 90vw;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #modal label {
      font-weight: bold;
      font-size: 0.9rem;
    }
    #modal input, #modal select, #modal textarea {
      width: 100%;
      padding: 0.4rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    #modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    #modal-buttons button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #modal-save {
      background-color: #3b82f6;
      color: white;
    }
    #modal-cancel {
      background-color: #ef4444;
      color: white;
    }
    /* Filters & Metrics */
    #filters {
      display: flex;
      gap: 0.7rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    #filters input, #filters select {
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    #metrics {
      font-size: 0.9rem;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <button id="add-column-btn">+ Nova Etapa</button>

  <div id="filters">
    <input type="text" id="filter-title" placeholder="Filtrar por título" />
    <select id="filter-priority">
      <option value="">Todas prioridades</option>
      <option value="Baixa">Baixa</option>
      <option value="Média">Média</option>
      <option value="Alta">Alta</option>
    </select>
    <input type="text" id="filter-responsible" placeholder="Filtrar por responsável" />
  </div>

  <div id="columns-container"></div>

  <div id="metrics"></div>

  <!-- Modal de edição -->
  <div id="modal-bg">
    <div id="modal">
      <label for="modal-title">Título:</label>
      <input id="modal-title" type="text" />

      <label for="modal-desc">Descrição:</label>
      <textarea id="modal-desc" rows="3"></textarea>

      <label for="modal-priority">Prioridade:</label>
      <select id="modal-priority">
        <option value="Baixa">Baixa</option>
        <option value="Média">Média</option>
        <option value="Alta">Alta</option>
      </select>

      <label for="modal-responsible">Responsável:</label>
      <input id="modal-responsible" type="text" />

      <div id="modal-buttons">
        <button id="modal-save">Salvar</button>
        <button id="modal-cancel">Cancelar</button>
      </div>
    </div>
  </div>

<script>
  // Dados iniciais
  let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
  let columns = JSON.parse(localStorage.getItem('columns')) || [
    { id: 'todo', name: 'A Fazer' },
    { id: 'in-progress', name: 'Em Progresso' },
    { id: 'done', name: 'Concluído' }
  ];

  // Salva dados no localStorage
  function saveTasks() {
    localStorage.setItem('tasks', JSON.stringify(tasks));
    renderColumns();
    updateMetrics();
  }
  function saveColumns() {
    localStorage.setItem('columns', JSON.stringify(columns));
  }

  // Renderiza as colunas e tarefas
  function renderColumns() {
    const container = document.getElementById('columns-container');
    container.innerHTML = '';

    columns.forEach((col, idx) => {
      const colDiv = document.createElement('div');
      colDiv.className = 'column';

      // Cabeçalho com input para editar nome
      const headerDiv = document.createElement('div');
      headerDiv.className = 'column-header';

      const inputTitle = document.createElement('input');
      inputTitle.type = 'text';
      inputTitle.value = col.name;
      inputTitle.title = "Clique e altere o nome da etapa";
      inputTitle.addEventListener('change', e => {
        const val = e.target.value.trim();
        if (val) {
          columns[idx].name = val;
          saveColumns();
          renderColumns();
        } else {
          // Não permite nome vazio, restaura anterior
          e.target.value = columns[idx].name;
        }
      });

      headerDiv.appendChild(inputTitle);

      // Botão remover coluna (exceto se só restar uma)
      if (columns.length > 1) {
        const delBtn = document.createElement('button');
        delBtn.className = 'remove-column-btn';
        delBtn.textContent = '✕';
        delBtn.title = 'Remover etapa (as tarefas serão movidas para a primeira etapa)';
        delBtn.onclick = () => {
          // Move as tarefas da coluna para a primeira
          tasks.forEach(task => {
            if (task.status === col.id) {
              task.status = columns[0].id;
            }
          });
          columns.splice(idx, 1);
          saveColumns();
          saveTasks();
        };
        headerDiv.appendChild(delBtn);
      }

      colDiv.appendChild(headerDiv);

      // Lista de tarefas da coluna
      const ul = document.createElement('ul');
      ul.className = 'task-list';
      ul.id = col.id;

      ul.addEventListener('dragover', allowDrop);
      ul.addEventListener('drop', drop);

      tasks.filter(t => t.status === col.id).forEach(task => {
        const li = document.createElement('li');
        li.textContent = task.title;
        li.draggable = true;
        li.dataset.id = task.id;

        li.addEventListener('dragstart', dragStart);
        li.addEventListener('dragend', dragEnd);
        li.addEventListener('click', () => openModal(task.id));

        ul.appendChild(li);
      });

      colDiv.appendChild(ul);
      container.appendChild(colDiv);
    });

    // Ajusta grid colunas conforme qtde
    const colsCount = columns.length;
    const maxCols = 5;
    document.getElementById('columns-container').style.gridTemplateColumns = `repeat(${colsCount > maxCols ? maxCols : colsCount}, minmax(0, 1fr))`;
  }

  // Adiciona nova coluna via prompt
  function addColumn() {
    let nome = prompt('Digite o nome da nova etapa:');
    if (!nome) return;
    nome = nome.trim();
    if (!nome) return;

    // Gera ID baseado no nome
    const idBase = nome.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/\s+/g, '-');
    let id = idBase;
    let i = 1;
    while(columns.some(c => c.id === id)) {
      id = `${idBase}-${i++}`;
    }

    columns.push({ id, name: nome });
    saveColumns();
    renderColumns();
  }

  // Drag & Drop Handlers
  let draggedTaskId = null;

  function dragStart(event) {
    draggedTaskId = event.target.dataset.id;
    event.dataTransfer.setData('text/plain', draggedTaskId);
    event.dataTransfer.effectAllowed = 'move';
    event.target.classList.add('dragging');
  }

  function dragEnd(event) {
    event.target.classList.remove('dragging');
    draggedTaskId = null;
  }

  function allowDrop(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
  }

  function drop(event) {
    event.preventDefault();
    const dropZone = event.currentTarget;
    const id = event.dataTransfer.getData('text/plain');

    const task = tasks.find(t => t.id == id);
    if (!task) return;

    if (task.status !== dropZone.id) {
      task.status = dropZone.id;
      saveTasks();
    }
  }

  // Modal de edição
  let currentEditTaskId = null;

  const modalBg = document.getElementById('modal-bg');
  const modalTitle = document.getElementById('modal-title');
  const modalDesc = document.getElementById('modal-desc');
  const modalPriority = document.getElementById('modal-priority');
  const modalResponsible = document.getElementById('modal-responsible');
  const modalSaveBtn = document.getElementById('modal-save');
  const modalCancelBtn = document.getElementById('modal-cancel');

  function openModal(id) {
    currentEditTaskId = id;
    const task = tasks.find(t => t.id == id);
    if (!task) return;

    modalTitle.value = task.title;
    modalDesc.value = task.description;
    modalPriority.value = task.priority;
    modalResponsible.value = task.responsible;

    modalBg.style.display = 'flex';
  }

  function closeModal() {
    modalBg.style.display = 'none';
    currentEditTaskId = null;
  }

  modalSaveBtn.addEventListener('click', () => {
    if (!currentEditTaskId) return;

    const task = tasks.find(t => t.id == currentEditTaskId);
    if (!task) return;

    task.title = modalTitle.value.trim() || task.title;
    task.description = modalDesc.value.trim();
    task.priority = modalPriority.value;
    task.responsible = modalResponsible.value.trim();

    saveTasks();
    closeModal();
  });

  modalCancelBtn.addEventListener('click', closeModal);
  modalBg.addEventListener('click', e => {
    if (e.target === modalBg) closeModal();
  });

  // Filtros
  function applyFilters() {
    const titleFilter = document.getElementById('filter-title').value.toLowerCase();
    const priorityFilter = document.getElementById('filter-priority').value;
    const responsibleFilter = document.getElementById('filter-responsible').value.toLowerCase();

    columns.forEach(col => {
      const ul = document.getElementById(col.id);
      if (!ul) return;

      for (const li of ul.children) {
        const task = tasks.find(t => t.id == li.dataset.id);
        if (!task) continue;

        const matchTitle = task.title.toLowerCase().includes(titleFilter);
        const matchPriority = priorityFilter === '' || task.priority === priorityFilter;
        const matchResponsible = task.responsible.toLowerCase().includes(responsibleFilter);

        li.style.display = (matchTitle && matchPriority && matchResponsible) ? '' : 'none';
      }
    });
  }

  document.getElementById('filter-title').addEventListener('input', applyFilters);
  document.getElementById('filter-priority').addEventListener('change', applyFilters);
  document.getElementById('filter-responsible').addEventListener('input', applyFilters);

  // Métricas simples
  function updateMetrics() {
    const total = tasks.length;

    // Contagem por status (coluna)
    const byStatus = {};
    columns.forEach(col => byStatus[col.id] = 0);
    tasks.forEach(t => {
      if (byStatus[t.status] !== undefined) byStatus[t.status]++;
    });

    // Contagem por prioridade
    const byPriority = { Baixa: 0, Média: 0, Alta: 0 };
    tasks.forEach(t => {
      if (byPriority[t.priority] !== undefined) byPriority[t.priority]++;
    });

    const metricsDiv = document.getElementById('metrics');

    let statusText = columns.map(col => `${col.name}: <b>${byStatus[col.id]}</b>`).join(' | ');

    metricsDiv.innerHTML = `
      Total de tarefas: <b>${total}</b><br/>
      ${statusText}<br/>
      Prioridade - Baixa: <b>${byPriority.Baixa}</b>, Média: <b>${byPriority.Média}</b>, Alta: <b>${byPriority.Alta}</b>
    `;
  }

  // Botão adicionar coluna
  document.getElementById('add-column-btn').addEventListener('click', addColumn);

  // Inicialização
  renderColumns();
  updateMetrics();
</script>
</body>
</html>
